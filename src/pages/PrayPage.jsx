import { useParams } from 'react-router-dom';
import {Notes, PrayRound, ReturnToSchedule} from "../components";
import {useState} from "react";
import {Repeat} from "lucide-react";
import {getAuthGroup} from "../utils";
import { Groups } from '../data';

export default function QuietTimePage() {
    const { prayId } = useParams();

    const group = getAuthGroup()
    const roundIndex = Number(prayId); 

    const questions = [
        "Какую самую важную вещь в жизни вы игнорировали, но теперь она требует вашего внимания?",
        "Когда в последний раз вы испытывали настоящую радость – и что мешало вам раньше?",
        "Какой секрет о себе вы скрываете даже от самого себя?",
        "Как выглядела бы ваша жизнь, если бы у вас была абсолютная свобода?",
        "Как бы вы описали голос своего сердца – и что он говорит вам прямо сейчас?",
        "Какую боль вы все еще носите в себе, и какую парадоксальную пользу она вам приносит?",
        "За что вы до сих пор не смогли себя простить?",
        "Какое самое большое разочарование сформировало вас?",
        "Какой момент в вашей жизни вас глубже всего затронул – и почему?",
        "Когда в последний раз вы плакали – и что к этому привело?",
        "Если бы вы могли сказать кому-то то, чего никогда не говорили, кому бы это было адресовано и что бы вы сказали?",
        "Какие отношения в вашей жизни изменили вас больше всего – и почему?",
        "Какое слово или жест от близкого человека оказал на вас наибольшее влияние – и что это для вас значило?",
        "Что вам больше всего нужно услышать от самого близкого вам человека?",
        "Как бы вы описали свои отношения с самим собой одним словом?",
        "Если бы вы знали, что не можете потерпеть неудачу, что бы вы сделали прямо сейчас?",
        "Какой страх больше всего вас сдерживает – и что случилось бы, если бы вы его отпустили?",
        "На что бы вы решились, если бы у вас остался всего один месяц жизни?",
        "Какой совет вы бы дали себе в молодости?",
        "Что мешает вам жить подлинной жизнью – и как можно убрать это препятствие?",

        "Как ты реально себя чувствуешь сейчас, если отбросить стандартные ответы?",
        "В чём ты больше всего нуждаешься от Бога на этой неделе?",
        "Есть ли что-то, что ты боишься рассказать другим, но хочешь доверить Богу?",
        "Как ты чувствуешь себя в своей вере в последнее время — растёт ли она или остывает?",
        "Была ли ситуация на этой неделе, где тебе трудно было поступить по-христиански?",
        "Как ты справляешься с сомнениями или трудными вопросами о Боге?",
        "Есть ли у тебя мечта, о которой ты редко говоришь, но она жива в твоём сердце?",
        "Какая молитва у тебя давно без ответа, и как ты это переживаешь?",
        "Чувствуешь ли ты себя в чём-то одиноким? В чём именно?",
        "Что последнее тебя сильно вдохновило в Библии?",
        "Есть ли в тебе сейчас что-то, за что тебе стыдно или тяжело на сердце?",
        "Как ты видишь свою роль в теле Христа (в церкви, в служении)?",
        "Какие внутренние битвы ты сейчас ведёшь?",
        "Как ты на самом деле воспринимаешь Божью любовь к себе?",
        "В чём тебе нужно прощение — от Бога, от других или от себя?",
        "Кто или что сейчас больше всего влияет на твою духовную жизнь?",
        "Есть ли у тебя неразрешённый конфликт или боль, которую ты носишь?",
        "Что ты хотел бы, чтобы Бог изменил в тебе прямо сейчас?",
        "Кем ты хочешь быть в Божьих глазах через 5 лет?",
        "Как я могу молиться за тебя на этой неделе, чтобы ты реально это почувствовал?",

        "Если бы Бог мог прямо сейчас ответить на один твой вопрос — о чём бы ты спросил?",
        "Что в тебе скрыто от других, но ты бы хотел, чтобы кто-то это понял без слов?",
        "Какая истина о тебе, которую ты боишься принять?",
        "Какое обещание ты дал Богу или себе, но до сих пор не исполнил?",
        "В каких моментах ты чувствуешь себя особенно живым?",
        "Что в тебе сейчас просит исцеления?",
        "Какая мысль не даёт тебе покоя в последнее время?",
        "Если бы ты мог что-то исправить в прошлом, что бы это было и почему?",
        "Что ты больше всего хочешь почувствовать в молитве?",
        "Какая истина из Библии тебе даётся труднее всего — и почему?",

        "Что ты хотел бы передать своим будущим детям или младшим братьям/сёстрам о жизни с Богом?",
        "Какая песня или история сейчас особенно говорит к твоему сердцу?",
        "Что в тебе хочет быть услышанным прямо сейчас?",
        "Если бы ты мог начать всё сначала, что бы ты сделал по-другому?",
        "Какие слова Бога ты хочешь услышать больше всего?",
        "Как ты чувствуешь себя, когда Бог молчит?",
        "Что бы ты хотел, чтобы о тебе сказали на твоих похоронах?",
        "Какая самая большая победа, которую ты недооцениваешь?",
        "Где ты больше всего чувствуешь Божье присутствие?",
        "Какой шаг в вере ты откладываешь, но знаешь, что должен сделать?"
    ];


    const mergeMap = {
        0: [0, 2],
        1: [1],
        2: [0, 2],
        3: [3, 4],
        4: [3, 4],
        5: [5, 6],
        6: [5, 6]
    };

    const [questionId, setQuestionId] = useState(0);

    if (!group) {
        return <div>не найден</div>;
    }

    function randomNumber() {
        return Math.floor(Math.random() * questions.length);
    }

    const getMembersForGroupIds = (ids) => {
        return ids.flatMap(targetId => {
            // Ищем группу перебором, чтобы ID точно совпал, даже если порядок в JSON сбит
            const foundGroup = Groups.find(g => g.id === targetId);
            
            // Если группы нет или в ней нет людей — возвращаем пустой массив
            if (!foundGroup || !foundGroup.members) return [];
            
            return foundGroup.members;
        });
    };

    if (group.id === 7) {
        const allPrayerMeetings = [
            { title: "Группы GodIsPower и ИБТ", groupIds: [0, 2] },
            { title: "Группа Ч.С.В.", groupIds: [1] },
            { title: "Группа ДВСИ х Милашки", groupIds: [3, 4] },
            { title: "Группы Небезгрешные х K-Plove", groupIds: [5, 6] },
        ];

        return (
            <div className="container">
                <ReturnToSchedule />
                {allPrayerMeetings.map((meeting, index) => {
                    const members = getMembersForGroupIds(meeting.groupIds);
                    // Добавляем ключевое слово return
                    return ( 
                        <div key={index} className="mb-8">
                            <h3 className="mb-2 font-bold text-2xl">{meeting.title}:</h3>
                            <PrayRound allMembers={members} groupIds={meeting.groupIds} roundId={prayId} />
                        </div>
                    );
                })}
            </div>
        );
    }

    const effectiveGroupIds = mergeMap[group.id] || [group.id];
    const currentMembers = getMembersForGroupIds(effectiveGroupIds);

    return (
        <div>
            <div className="container">
                <ReturnToSchedule/>
                <h3 className="mb-2 font-bold text-2xl">Пары:</h3>
                <PrayRound allMembers={currentMembers} groupIds={effectiveGroupIds} roundId={prayId}/>
                <h3 className="mt-4 mb-2 font-bold text-2xl">Вопросы:</h3>
                <div className="flex items-start gap-2">
                    <div className="w-full px-4 p-2 text-xl border border-black rounded-xl">{questions[questionId] || "Обнови"}</div>
                    <button className="p-2 border border-black rounded-xl" onClick={() => setQuestionId(randomNumber)}><Repeat/></button>
                </div>
                <Notes storageKey={`notes_pray_${prayId}`}/>
            </div>
        </div>
    );
}
